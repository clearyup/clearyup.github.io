<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
        <title>YOLOv5训练自己的数据集 - clear</title><meta name="Description" content="hugo blog"><meta property="og:title" content="YOLOv5训练自己的数据集" />
<meta property="og:description" content="YOLOv5炼丹 yolo目标检测算法是you only look once,图片只需要被检测一次就可以出结果 VOC数据集转换为Yolo数据集格式 windows" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://clearyup.github.io/posts/yolo/" /><meta property="og:image" content="https://clearyup.github.io/logo.png"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-05-16T20:57:38&#43;08:00" />
<meta property="article:modified_time" content="2021-05-16T20:57:38&#43;08:00" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://clearyup.github.io/logo.png"/>

<meta name="twitter:title" content="YOLOv5训练自己的数据集"/>
<meta name="twitter:description" content="YOLOv5炼丹 yolo目标检测算法是you only look once,图片只需要被检测一次就可以出结果 VOC数据集转换为Yolo数据集格式 windows"/>
<meta name="application-name" content="clear">
<meta name="apple-mobile-web-app-title" content="clear"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://clearyup.github.io/posts/yolo/" /><link rel="prev" href="https://clearyup.github.io/posts/vim/" /><link rel="stylesheet" href="/lib/normalize/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"><link rel="stylesheet" href="/lib/animate/animate.min.css"><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "YOLOv5训练自己的数据集",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/clearyup.github.io\/posts\/yolo\/"
        },"genre": "posts","keywords": "yolov5","wordcount":  6862 ,
        "url": "https:\/\/clearyup.github.io\/posts\/yolo\/","datePublished": "2021-05-16T20:57:38+08:00","dateModified": "2021-05-16T20:57:38+08:00","publisher": {
            "@type": "Organization",
            "name": ""},"author": {
                "@type": "Person",
                "name": "@clear"
            },"description": ""
    }
    </script></head>
    <body header-desktop="fixed" header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="clear"><span class="header-title-pre"><i class='fas fa-feather-alt'></i></span>Always like this.</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"><i class='fas fa-fw fa-fan fa-spin'></i> 所有文章 </a><a class="menu-item" href="/tags/"><i class='fas fa-tags'></i> 标签 </a><a class="menu-item" href="/categories/"><i class='fas fa-bookmark'></i> 分类 </a><a class="menu-item" href="/about/"><i class='fab fa-black-tie'></i> About </a><a class="menu-item" href="https://github.com/clearyup" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw'></i>  </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="搜索文章标题或内容..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="搜索">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="清空">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="clear"><span class="header-title-pre"><i class='fas fa-feather-alt'></i></span>Always like this.</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="搜索文章标题或内容..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="搜索">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="清空">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        取消
                    </a>
                </div><a class="menu-item" href="/posts/" title=""><i class='fas fa-fw fa-fan fa-spin'></i>所有文章</a><a class="menu-item" href="/tags/" title=""><i class='fas fa-tags'></i>标签</a><a class="menu-item" href="/categories/" title=""><i class='fas fa-bookmark'></i>分类</a><a class="menu-item" href="/about/" title=""><i class='fab fa-black-tie'></i>About</a><a class="menu-item" href="https://github.com/clearyup" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw'></i></a><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                <i class="fas fa-adjust fa-fw"></i>
            </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">目录</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animated flipInX">YOLOv5训练自己的数据集</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="clearyup.github.io" title="Author" rel=" author" class="author"><i class="fas fa-user-circle fa-fw"></i>@clear</a></span>&nbsp;<span class="post-category">收录于 <a href="/categories/python/"><i class="far fa-folder fa-fw"></i>python</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2021-05-16">2021-05-16</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 6862 字&nbsp;
                <i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 14 分钟&nbsp;</div>
        </div><div class="details toc" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>目录</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#voc数据集转换为yolo数据集格式">VOC数据集转换为Yolo数据集格式</a></li>
    <li><a href="#colab">colab</a>
      <ul>
        <li><a href="#下载yolov5源码">下载yolov5源码</a></li>
        <li><a href="#装载谷歌云盘">装载谷歌云盘</a></li>
        <li><a href="#创建文件夹">创建文件夹</a></li>
        <li><a href="#生成训练集测试集验证集目录">生成训练集测试集验证集目录</a></li>
        <li><a href="#转换标注格式">转换标注格式</a></li>
        <li><a href="#更改配置文件">更改配置文件</a></li>
        <li><a href="#开始训练">开始训练</a></li>
        <li><a href="#训练结果分析">训练结果分析</a></li>
        <li><a href="#测试模型">测试模型</a></li>
        <li><a href="#开始预测结果">开始预测结果</a></li>
      </ul>
    </li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><h1 id="yolov5炼丹">YOLOv5炼丹</h1>
<blockquote>
<p>yolo目标检测算法是<code>you only look once</code>,图片只需要被检测一次就可以出结果</p>
</blockquote>
<h2 id="voc数据集转换为yolo数据集格式">VOC数据集转换为Yolo数据集格式</h2>
<blockquote>
<p>windows系统</p>
</blockquote>
<ul>
<li>images 里面存放的是训练图片, labels_voc 里面存放的是 .xml (标签)，labels里面存放的是*.txt(转换后的标签),  classes.names 存放所有分类名字， 每行一个类别</li>
</ul>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/clearyup/picgo/img/20210517220422.png"
        data-srcset="https://cdn.jsdelivr.net/gh/clearyup/picgo/img/20210517220422.png, https://cdn.jsdelivr.net/gh/clearyup/picgo/img/20210517220422.png 1.5x, https://cdn.jsdelivr.net/gh/clearyup/picgo/img/20210517220422.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/clearyup/picgo/img/20210517220422.png"
        title="https://cdn.jsdelivr.net/gh/clearyup/picgo/img/20210517220422.png" /></p>
<ul>
<li>转换python代码</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="c1">#coding:utf-8</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">xml.etree.ElementTree</span> <span class="kn">as</span> <span class="nn">ET</span>

<span class="k">def</span> <span class="nf">xml_reader</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="s2">&#34;&#34;&#34; Parse a PASCAL VOC xml file &#34;&#34;&#34;</span>
    <span class="n">tree</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="n">size</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;size&#39;</span><span class="p">)</span>
    <span class="n">width</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">size</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;width&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
    <span class="n">height</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">size</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;height&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
    <span class="n">objects</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">tree</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;object&#39;</span><span class="p">):</span>
        <span class="n">obj_struct</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">obj_struct</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span>
        <span class="n">bbox</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;bndbox&#39;</span><span class="p">)</span>
        <span class="n">obj_struct</span><span class="p">[</span><span class="s1">&#39;bbox&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">bbox</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;xmin&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">),</span>
                              <span class="nb">int</span><span class="p">(</span><span class="n">bbox</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;ymin&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">),</span>
                              <span class="nb">int</span><span class="p">(</span><span class="n">bbox</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;xmax&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">),</span>
                              <span class="nb">int</span><span class="p">(</span><span class="n">bbox</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;ymax&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">)]</span>
        <span class="n">objects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obj_struct</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">objects</span>


<span class="k">def</span> <span class="nf">voc2yolo</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="n">classes_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&#34;classes.names&#34;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()):</span>
            <span class="n">class_name</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">classes_dict</span><span class="p">[</span><span class="n">class_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">idx</span>
    
    <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">objects</span> <span class="o">=</span> <span class="n">xml_reader</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

    <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">objects</span><span class="p">:</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="n">obj</span><span class="p">[</span><span class="s1">&#39;bbox&#39;</span><span class="p">]</span>
        <span class="n">class_name</span> <span class="o">=</span> <span class="n">obj</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
        <span class="n">label</span> <span class="o">=</span> <span class="n">classes_dict</span><span class="p">[</span><span class="n">class_name</span><span class="p">]</span>
        <span class="n">cx</span> <span class="o">=</span> <span class="p">(</span><span class="n">x2</span><span class="o">+</span><span class="n">x</span><span class="p">)</span><span class="o">*</span><span class="mf">0.5</span> <span class="o">/</span> <span class="n">width</span>
        <span class="n">cy</span> <span class="o">=</span> <span class="p">(</span><span class="n">y2</span><span class="o">+</span><span class="n">y</span><span class="p">)</span><span class="o">*</span><span class="mf">0.5</span> <span class="o">/</span> <span class="n">height</span>
        <span class="n">w</span> <span class="o">=</span> <span class="p">(</span><span class="n">x2</span><span class="o">-</span><span class="n">x</span><span class="p">)</span><span class="o">*</span><span class="mf">1.</span> <span class="o">/</span> <span class="n">width</span>
        <span class="n">h</span> <span class="o">=</span> <span class="p">(</span><span class="n">y2</span><span class="o">-</span><span class="n">y</span><span class="p">)</span><span class="o">*</span><span class="mf">1.</span> <span class="o">/</span> <span class="n">height</span>
        <span class="n">line</span> <span class="o">=</span> <span class="s2">&#34;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%.6f</span><span class="s2"> </span><span class="si">%.6f</span><span class="s2"> </span><span class="si">%.6f</span><span class="s2"> </span><span class="si">%.6f</span><span class="se">\n</span><span class="s2">&#34;</span> <span class="o">%</span> <span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">)</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

    <span class="n">txt_name</span> <span class="o">=</span> <span class="n">filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&#34;.xml&#34;</span><span class="p">,</span> <span class="s2">&#34;.txt&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&#34;labels_voc&#34;</span><span class="p">,</span> <span class="s2">&#34;labels&#34;</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">txt_name</span><span class="p">,</span> <span class="s2">&#34;w&#34;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">get_image_list</span><span class="p">(</span><span class="n">image_dir</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;jpg&#39;</span><span class="p">,</span> <span class="s1">&#39;jpeg&#39;</span><span class="p">,</span> <span class="s1">&#39;JPG&#39;</span><span class="p">,</span> <span class="s1">&#39;JPEG&#39;</span><span class="p">,</span><span class="s1">&#39;png&#39;</span><span class="p">]):</span>
    <span class="s1">&#39;&#39;&#39;get all image path ends with suffix&#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">image_dir</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&#34;PATH:</span><span class="si">%s</span><span class="s2"> not exists&#34;</span> <span class="o">%</span> <span class="n">image_dir</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[]</span>
    <span class="n">imglist</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">root</span><span class="p">,</span> <span class="n">sdirs</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">image_dir</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">files</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="n">filepath</span> <span class="o">=</span> <span class="s2">&#34;data/custom/&#34;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span>
            <span class="k">if</span> <span class="n">filename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">suffix</span><span class="p">:</span>
                <span class="n">imglist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">imglist</span>


<span class="k">def</span> <span class="nf">imglist2file</span><span class="p">(</span><span class="n">imglist</span><span class="p">):</span>
    <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">imglist</span><span class="p">)</span>
    <span class="n">train_list</span> <span class="o">=</span> <span class="n">imglist</span><span class="p">[:</span><span class="o">-</span><span class="mi">100</span><span class="p">]</span>
    <span class="n">valid_list</span> <span class="o">=</span> <span class="n">imglist</span><span class="p">[</span><span class="o">-</span><span class="mi">100</span><span class="p">:]</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&#34;train.txt&#34;</span><span class="p">,</span> <span class="s2">&#34;w&#34;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">train_list</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&#34;valid.txt&#34;</span><span class="p">,</span> <span class="s2">&#34;w&#34;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">valid_list</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
    <span class="n">xml_path_list</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&#34;labels_voc/*.xml&#34;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">xml_path</span> <span class="ow">in</span> <span class="n">xml_path_list</span><span class="p">:</span>
        <span class="n">voc2yolo</span><span class="p">(</span><span class="n">xml_path</span><span class="p">)</span>


    <span class="n">imglist</span> <span class="o">=</span> <span class="n">get_image_list</span><span class="p">(</span><span class="s2">&#34;images&#34;</span><span class="p">)</span>
    <span class="n">imglist2file</span><span class="p">(</span><span class="n">imglist</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="colab">colab</h2>
<blockquote>
<p>整个训练流程大致是训练你自己的数据集获得权重文件，然后使用权重文件来对你的图片进行预测，输出结果</p>
</blockquote>
<h3 id="下载yolov5源码">下载yolov5源码</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">!git init
!git clone https://github.com/ultralytics/yolov5.git
</code></pre></td></tr></table>
</div>
</div><h3 id="装载谷歌云盘">装载谷歌云盘</h3>
<ul>
<li>
<p>将你的数据集<code>images.zip</code>和标注集<code>Annotation.zip</code>和<code>yolov5</code>要用到的<code>权重文件</code>上传到谷歌云盘,训练的时候从谷歌云盘加载</p>
</li>
<li>
<p>将这两个压缩包解压到<code>yolov5</code>目录下</p>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">!unzip /content/drive/MyDrive/Annotations.zip -d /content/yolov5/data/
</code></pre></td></tr></table>
</div>
</div><ul>
<li>解压<code>images.zip</code>之前先删除<code>yolov5/data/images</code>这个文件夹原有的图片</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">!rm -rf /content/yolov5/data/images/*
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">!unzip /content/drive/MyDrive/images.zip -d /content/yolov5/data/images
</code></pre></td></tr></table>
</div>
</div><ul>
<li>拷贝权重文件到<code>yolov5</code>的指定目录</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">!cp /content/drive/MyDrive/yolov5s.pt  /content/yolov5/weights
</code></pre></td></tr></table>
</div>
</div><h3 id="创建文件夹">创建文件夹</h3>
<ul>
<li>在 yolov5/data 下创建以下几个文件夹 <code>ImageSets</code>, <code>labels</code>, <code>JPEGImages</code></li>
<li>解压完成所需文件和创建文件夹后的目录结构如下</li>
</ul>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/clearyup/picgo/img/20210519200848.png"
        data-srcset="https://cdn.jsdelivr.net/gh/clearyup/picgo/img/20210519200848.png, https://cdn.jsdelivr.net/gh/clearyup/picgo/img/20210519200848.png 1.5x, https://cdn.jsdelivr.net/gh/clearyup/picgo/img/20210519200848.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/clearyup/picgo/img/20210519200848.png"
        title="https://cdn.jsdelivr.net/gh/clearyup/picgo/img/20210519200848.png" /></p>
<h3 id="生成训练集测试集验证集目录">生成训练集测试集验证集目录</h3>
<ul>
<li>这里我们使用<code>python</code>脚本生成<code>train.txt</code>, <code>test.txt</code>, <code>train.txt</code>, <code>val.txt</code></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">import os
import random
<span class="nv">trainval_percent</span> <span class="o">=</span> 0.1
<span class="nv">train_percent</span> <span class="o">=</span> 0.9
<span class="nv">xmlfilepath</span> <span class="o">=</span> <span class="s1">&#39;/content/yolov5/data/Annotations&#39;</span>
<span class="nv">txtsavepath</span> <span class="o">=</span> <span class="s1">&#39;/content/yolov5/data/ImageSets&#39;</span>
<span class="nv">total_xml</span> <span class="o">=</span> os.listdir<span class="o">(</span>xmlfilepath<span class="o">)</span>
<span class="nv">num</span> <span class="o">=</span> len<span class="o">(</span>total_xml<span class="o">)</span>
<span class="nv">list</span> <span class="o">=</span> range<span class="o">(</span>num<span class="o">)</span>
<span class="nv">tv</span> <span class="o">=</span> int<span class="o">(</span>num * trainval_percent<span class="o">)</span>
<span class="nv">tr</span> <span class="o">=</span> int<span class="o">(</span>tv * train_percent<span class="o">)</span>
<span class="nv">trainval</span> <span class="o">=</span> random.sample<span class="o">(</span>list, tv<span class="o">)</span>
<span class="nv">train</span> <span class="o">=</span> random.sample<span class="o">(</span>trainval, tr<span class="o">)</span>
<span class="nv">ftrainval</span> <span class="o">=</span> open<span class="o">(</span><span class="s1">&#39;/content/yolov5/data/ImageSets/trainval.txt&#39;</span>, <span class="s1">&#39;w&#39;</span><span class="o">)</span>
<span class="nv">ftest</span> <span class="o">=</span> open<span class="o">(</span><span class="s1">&#39;/content/yolov5/data/ImageSets/test.txt&#39;</span>, <span class="s1">&#39;w&#39;</span><span class="o">)</span>
<span class="nv">ftrain</span> <span class="o">=</span> open<span class="o">(</span><span class="s1">&#39;/content/yolov5/data/ImageSets/train.txt&#39;</span>, <span class="s1">&#39;w&#39;</span><span class="o">)</span>
<span class="nv">fval</span> <span class="o">=</span> open<span class="o">(</span><span class="s1">&#39;/content/yolov5/data/ImageSets/val.txt&#39;</span>, <span class="s1">&#39;w&#39;</span><span class="o">)</span>
<span class="k">for</span> i in list:
    <span class="nv">name</span> <span class="o">=</span> total_xml<span class="o">[</span>i<span class="o">][</span>:-4<span class="o">]</span> + <span class="s1">&#39;\n&#39;</span>
    <span class="k">if</span> i in trainval:
        ftrainval.write<span class="o">(</span>name<span class="o">)</span>
        <span class="k">if</span> i in train:
            ftest.write<span class="o">(</span>name<span class="o">)</span>
        <span class="k">else</span>:
            fval.write<span class="o">(</span>name<span class="o">)</span>
    <span class="k">else</span>:
        ftrain.write<span class="o">(</span>name<span class="o">)</span>
ftrainval.close<span class="o">()</span>
ftrain.close<span class="o">()</span>
fval.close<span class="o">()</span>
ftest.close<span class="o">()</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="转换标注格式">转换标注格式</h3>
<ul>
<li><code>yolov5</code>使用的是<code>.txt</code>格式的标注文件,如果你的标注格式是 类似这种<code>voc 2007</code>的<code>.xml</code>格式</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-xml" data-lang="xml"><span class="cp">&lt;?xml version=&#39;1.0&#39; encoding=&#39;utf-8&#39;?&gt;</span>
<span class="nt">&lt;annotation&gt;</span>
	<span class="nt">&lt;folder&gt;</span>Annotation<span class="nt">&lt;/folder&gt;</span>
	<span class="nt">&lt;filename&gt;</span>IMG_000001.jpg<span class="nt">&lt;/filename&gt;</span>
	<span class="nt">&lt;path&gt;</span>D:\Annotation\IMG_000001.jpg<span class="nt">&lt;/path&gt;</span>
	<span class="nt">&lt;source&gt;</span>
		<span class="nt">&lt;database&gt;</span>Unknown<span class="nt">&lt;/database&gt;</span>
	<span class="nt">&lt;/source&gt;</span>
	<span class="nt">&lt;size&gt;</span>
		<span class="nt">&lt;width&gt;</span>4608<span class="nt">&lt;/width&gt;</span>
		<span class="nt">&lt;height&gt;</span>2592<span class="nt">&lt;/height&gt;</span>
		<span class="nt">&lt;depth&gt;</span>3<span class="nt">&lt;/depth&gt;</span>
	<span class="nt">&lt;/size&gt;</span>
	<span class="nt">&lt;segmented&gt;</span>0<span class="nt">&lt;/segmented&gt;</span>
	<span class="nt">&lt;object&gt;</span>
		<span class="nt">&lt;name&gt;</span>巴黎翠凤蝶<span class="nt">&lt;/name&gt;</span>
		<span class="nt">&lt;pose&gt;</span>Unspecified<span class="nt">&lt;/pose&gt;</span>
		<span class="nt">&lt;truncated&gt;</span>0<span class="nt">&lt;/truncated&gt;</span>
		<span class="nt">&lt;difficult&gt;</span>0<span class="nt">&lt;/difficult&gt;</span>
		<span class="nt">&lt;bndbox&gt;</span>
			<span class="nt">&lt;xmin&gt;</span>1992<span class="nt">&lt;/xmin&gt;</span>
			<span class="nt">&lt;ymin&gt;</span>774<span class="nt">&lt;/ymin&gt;</span>
			<span class="nt">&lt;xmax&gt;</span>2826<span class="nt">&lt;/xmax&gt;</span>
			<span class="nt">&lt;ymax&gt;</span>1559<span class="nt">&lt;/ymax&gt;</span>
		<span class="nt">&lt;/bndbox&gt;</span>
	<span class="nt">&lt;/object&gt;</span>
<span class="nt">&lt;/annotation&gt;</span>

 


</code></pre></td></tr></table>
</div>
</div><ul>
<li>你可以使用以下<code>python</code>脚本进行<code>.xml</code>到<code>.txt</code>格式的转换</li>
<li><code>classes</code> 是数据集的类别</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">xml.etree.ElementTree</span> <span class="kn">as</span> <span class="nn">ET</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">listdir</span><span class="p">,</span> <span class="n">getcwd</span>
<span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">join</span>
<span class="n">sets</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">,</span> <span class="s1">&#39;test&#39;</span><span class="p">,</span><span class="s1">&#39;val&#39;</span><span class="p">]</span>
<span class="n">classes</span> <span class="o">=</span> <span class="p">[</span>
<span class="s2">&#34;巴黎翠凤蝶&#34;</span><span class="p">,</span>

<span class="s2">&#34;柑橘凤蝶&#34;</span><span class="p">,</span>

<span class="s2">&#34;玉带凤蝶&#34;</span><span class="p">,</span>

<span class="s2">&#34;碧凤蝶&#34;</span><span class="p">,</span>

<span class="s2">&#34;红基美凤蝶&#34;</span><span class="p">,</span>

<span class="s2">&#34;蓝凤蝶&#34;</span><span class="p">,</span>

<span class="s2">&#34;金裳凤蝶&#34;</span><span class="p">,</span>

<span class="s2">&#34;青凤蝶&#34;</span><span class="p">,</span>

<span class="s2">&#34;朴喙蝶&#34;</span><span class="p">,</span>

<span class="s2">&#34;密纹飒弄蝶&#34;</span><span class="p">,</span>

<span class="s2">&#34;小黄斑弄蝶&#34;</span><span class="p">,</span>

<span class="s2">&#34;无斑珂弄蝶&#34;</span><span class="p">,</span>

<span class="s2">&#34;直纹稻弄蝶&#34;</span><span class="p">,</span>

<span class="s2">&#34;花弄蝶&#34;</span><span class="p">,</span>

<span class="s2">&#34;隐纹谷弄蝶&#34;</span><span class="p">,</span>

<span class="s2">&#34;绢斑蝶&#34;</span><span class="p">,</span>

<span class="s2">&#34;虎斑蝶&#34;</span><span class="p">,</span>

<span class="s2">&#34;亮灰蝶&#34;</span><span class="p">,</span>

<span class="s2">&#34;咖灰蝶&#34;</span><span class="p">,</span>

<span class="s2">&#34;大紫琉璃灰蝶&#34;</span><span class="p">,</span>

<span class="s2">&#34;婀灰蝶&#34;</span><span class="p">,</span>

<span class="s2">&#34;曲纹紫灰蝶&#34;</span><span class="p">,</span>

<span class="s2">&#34;波太玄灰蝶&#34;</span><span class="p">,</span>

<span class="s2">&#34;玄灰蝶&#34;</span><span class="p">,</span>

<span class="s2">&#34;红灰蝶&#34;</span><span class="p">,</span>

<span class="s2">&#34;线灰蝶&#34;</span><span class="p">,</span>

<span class="s2">&#34;维纳斯眼灰蝶&#34;</span><span class="p">,</span>

<span class="s2">&#34;艳灰蝶&#34;</span><span class="p">,</span>

<span class="s2">&#34;蓝灰蝶&#34;</span><span class="p">,</span>

<span class="s2">&#34;青海红珠灰蝶&#34;</span><span class="p">,</span>

<span class="s2">&#34;古北拟酒眼蝶&#34;</span><span class="p">,</span>

<span class="s2">&#34;阿芬眼蝶&#34;</span><span class="p">,</span>

<span class="s2">&#34;拟稻眉眼蝶&#34;</span><span class="p">,</span>

<span class="s2">&#34;牧女珍眼蝶&#34;</span><span class="p">,</span>

<span class="s2">&#34;白眼蝶&#34;</span><span class="p">,</span>

<span class="s2">&#34;菩萨酒眼蝶&#34;</span><span class="p">,</span>

<span class="s2">&#34;西门珍眼蝶&#34;</span><span class="p">,</span>

<span class="s2">&#34;边纹黛眼蝶&#34;</span><span class="p">,</span>

<span class="s2">&#34;云粉蝶&#34;</span><span class="p">,</span>

<span class="s2">&#34;侏粉蝶&#34;</span><span class="p">,</span>

<span class="s2">&#34;大卫粉蝶&#34;</span><span class="p">,</span>

<span class="s2">&#34;大翅绢粉蝶&#34;</span><span class="p">,</span>

<span class="s2">&#34;山豆粉蝶&#34;</span><span class="p">,</span>

<span class="s2">&#34;橙黄豆粉蝶&#34;</span><span class="p">,</span>

<span class="s2">&#34;突角小粉蝶&#34;</span><span class="p">,</span>

<span class="s2">&#34;箭纹云粉蝶&#34;</span><span class="p">,</span>

<span class="s2">&#34;箭纹绢粉蝶&#34;</span><span class="p">,</span>

<span class="s2">&#34;红襟粉蝶&#34;</span><span class="p">,</span>

<span class="s2">&#34;绢粉蝶&#34;</span><span class="p">,</span>

<span class="s2">&#34;菜粉蝶&#34;</span><span class="p">,</span>

<span class="s2">&#34;镉黄迁粉蝶&#34;</span><span class="p">,</span>

<span class="s2">&#34;黎明豆粉蝶&#34;</span><span class="p">,</span>

<span class="s2">&#34;依帕绢蝶&#34;</span><span class="p">,</span>

<span class="s2">&#34;四川绢蝶&#34;</span><span class="p">,</span>

<span class="s2">&#34;珍珠绢蝶&#34;</span><span class="p">,</span>

<span class="s2">&#34;中环蛱蝶&#34;</span><span class="p">,</span>

<span class="s2">&#34;云豹蛱蝶&#34;</span><span class="p">,</span>

<span class="s2">&#34;伊诺小豹蛱蝶&#34;</span><span class="p">,</span>

<span class="s2">&#34;小红蛱蝶&#34;</span><span class="p">,</span>

<span class="s2">&#34;扬眉线蛱蝶&#34;</span><span class="p">,</span>

<span class="s2">&#34;斐豹蛱蝶&#34;</span><span class="p">,</span>

<span class="s2">&#34;曲斑珠蛱蝶&#34;</span><span class="p">,</span>

<span class="s2">&#34;柱菲蛱蝶&#34;</span><span class="p">,</span>

<span class="s2">&#34;柳紫闪蛱蝶&#34;</span><span class="p">,</span>

<span class="s2">&#34;灿福蛱蝶&#34;</span><span class="p">,</span>

<span class="s2">&#34;玄珠带蛱蝶&#34;</span><span class="p">,</span>

<span class="s2">&#34;珍蛱蝶&#34;</span><span class="p">,</span>

<span class="s2">&#34;琉璃蛱蝶&#34;</span><span class="p">,</span>

<span class="s2">&#34;白钩蛱蝶&#34;</span><span class="p">,</span>

<span class="s2">&#34;秀蛱蝶&#34;</span><span class="p">,</span>

<span class="s2">&#34;绢蛱蝶&#34;</span><span class="p">,</span>

<span class="s2">&#34;绿豹蛱蝶&#34;</span><span class="p">,</span>

<span class="s2">&#34;网蛱蝶&#34;</span><span class="p">,</span>

<span class="s2">&#34;美眼蛱蝶&#34;</span><span class="p">,</span>

<span class="s2">&#34;翠蓝眼蛱蝶&#34;</span><span class="p">,</span>

<span class="s2">&#34;老豹蛱蝶&#34;</span><span class="p">,</span>

<span class="s2">&#34;荨麻蛱蝶&#34;</span><span class="p">,</span>

<span class="s2">&#34;虬眉带蛱蝶&#34;</span><span class="p">,</span>

<span class="s2">&#34;蟾福蛱蝶&#34;</span><span class="p">,</span>

<span class="s2">&#34;钩翅眼蛱蝶&#34;</span><span class="p">,</span>

<span class="s2">&#34;银斑豹蛱蝶&#34;</span><span class="p">,</span>

<span class="s2">&#34;银豹蛱蝶&#34;</span><span class="p">,</span>

<span class="s2">&#34;链环蛱蝶&#34;</span><span class="p">,</span>

<span class="s2">&#34;锦瑟蛱蝶&#34;</span><span class="p">,</span>

<span class="s2">&#34;黄环蛱蝶&#34;</span><span class="p">,</span>

<span class="s2">&#34;黄钩蛱蝶&#34;</span><span class="p">,</span>

<span class="s2">&#34;黑网蛱蝶&#34;</span><span class="p">,</span>

<span class="s2">&#34;宽边黄粉蝶&#34;</span><span class="p">,</span>

<span class="s2">&#34;尖翅翠蛱蝶&#34;</span><span class="p">,</span>

<span class="s2">&#34;素弄蝶&#34;</span><span class="p">,</span>

<span class="s2">&#34;翠袖锯眼蝶&#34;</span><span class="p">,</span>

<span class="s2">&#34;蓝点紫斑蝶&#34;</span><span class="p">,</span>

<span class="s2">&#34;蛇目褐蚬蝶&#34;</span><span class="p">,</span>

<span class="s2">&#34;雅弄蝶&#34;</span><span class="p">,</span>

<span class="p">]</span>
<span class="k">def</span> <span class="nf">convert</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">box</span><span class="p">):</span>
    <span class="n">dw</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">/</span> <span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">dh</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">/</span> <span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">box</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">box</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mf">2.0</span>
    <span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="n">box</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">box</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">/</span> <span class="mf">2.0</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">box</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">box</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">h</span> <span class="o">=</span> <span class="n">box</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">box</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">*</span> <span class="n">dw</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">w</span> <span class="o">*</span> <span class="n">dw</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">y</span> <span class="o">*</span> <span class="n">dh</span>
    <span class="n">h</span> <span class="o">=</span> <span class="n">h</span> <span class="o">*</span> <span class="n">dh</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">convert_annotation</span><span class="p">(</span><span class="n">image_id</span><span class="p">):</span>
    <span class="n">in_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;/content/yolov5/data/Annotations/</span><span class="si">%s</span><span class="s1">.xml&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">image_id</span><span class="p">))</span>
    <span class="n">out_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;/content/yolov5/data/labels/</span><span class="si">%s</span><span class="s1">.txt&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">image_id</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
    <span class="n">tree</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">in_file</span><span class="p">)</span>
    <span class="n">root</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">getroot</span><span class="p">()</span>
    <span class="n">size</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;size&#39;</span><span class="p">)</span>
    <span class="n">w</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">size</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;width&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
    <span class="n">h</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">size</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;height&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">root</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="s1">&#39;object&#39;</span><span class="p">):</span>
        <span class="n">difficult</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;difficult&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span>
        <span class="bp">cls</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span>
        <span class="k">if</span> <span class="bp">cls</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">classes</span> <span class="ow">or</span> <span class="nb">int</span><span class="p">(</span><span class="n">difficult</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">cls_id</span> <span class="o">=</span> <span class="n">classes</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
        <span class="n">xmlbox</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;bndbox&#39;</span><span class="p">)</span>
        <span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">xmlbox</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;xmin&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">xmlbox</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;xmax&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">xmlbox</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;ymin&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">),</span>
             <span class="nb">float</span><span class="p">(</span><span class="n">xmlbox</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;ymax&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">))</span>
        <span class="n">bb</span> <span class="o">=</span> <span class="n">convert</span><span class="p">((</span><span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">),</span> <span class="n">b</span><span class="p">)</span>
        <span class="n">out_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">cls_id</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&#34; &#34;</span> <span class="o">+</span> <span class="s2">&#34; &#34;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">bb</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">wd</span> <span class="o">=</span> <span class="n">getcwd</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="n">wd</span><span class="p">)</span>
<span class="k">for</span> <span class="n">image_set</span> <span class="ow">in</span> <span class="n">sets</span><span class="p">:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s1">&#39;/content/yolov5/data/labels/&#39;</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="s1">&#39;/content/yolov5/data/labels/&#39;</span><span class="p">)</span>
    <span class="n">image_ids</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;/content/yolov5/data/ImageSets/</span><span class="si">%s</span><span class="s1">.txt&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">image_set</span><span class="p">))</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="n">list_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;/content/yolov5/data/</span><span class="si">%s</span><span class="s1">.txt&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">image_set</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">image_id</span> <span class="ow">in</span> <span class="n">image_ids</span><span class="p">:</span>
        <span class="n">list_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;/content/yolov5/data/images/</span><span class="si">%s</span><span class="s1">.jpg</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">image_id</span><span class="p">))</span>
        <span class="n">convert_annotation</span><span class="p">(</span><span class="n">image_id</span><span class="p">)</span>
    <span class="n">list_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="更改配置文件">更改配置文件</h3>
<ul>
<li>新建<code>mytrain.yaml</code>文件,上传到<code>/content/yolov5/data/mytrain.yaml</code></li>
<li><code>nc</code>是数据集里数据种类, <code>names</code>是类别名</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">train</span><span class="p">:</span><span class="w"> </span><span class="l">/content/yolov5/data/train.txt</span><span class="w">
</span><span class="w"></span><span class="nt">val</span><span class="p">:</span><span class="w"> </span><span class="l">/content/yolov5/data/val.txt</span><span class="w">
</span><span class="w"></span><span class="nt">test</span><span class="p">:</span><span class="w"> </span><span class="l">/content/yolov5/data/test.txt</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="nt">nc</span><span class="p">:</span><span class="w"> </span><span class="m">94</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="nt">names</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
</span><span class="w"></span><span class="s2">&#34;巴黎翠凤蝶&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="s2">&#34;柑橘凤蝶&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="s2">&#34;玉带凤蝶&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="s2">&#34;碧凤蝶&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="s2">&#34;红基美凤蝶&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="s2">&#34;蓝凤蝶&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="s2">&#34;金裳凤蝶&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="s2">&#34;青凤蝶&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="s2">&#34;朴喙蝶&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="s2">&#34;密纹飒弄蝶&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="s2">&#34;小黄斑弄蝶&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="s2">&#34;无斑珂弄蝶&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="s2">&#34;直纹稻弄蝶&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="s2">&#34;花弄蝶&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="s2">&#34;隐纹谷弄蝶&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="s2">&#34;绢斑蝶&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="s2">&#34;虎斑蝶&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="s2">&#34;亮灰蝶&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="s2">&#34;咖灰蝶&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="s2">&#34;大紫琉璃灰蝶&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="s2">&#34;婀灰蝶&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="s2">&#34;曲纹紫灰蝶&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="s2">&#34;波太玄灰蝶&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="s2">&#34;玄灰蝶&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="s2">&#34;红灰蝶&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="s2">&#34;线灰蝶&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="s2">&#34;维纳斯眼灰蝶&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="s2">&#34;艳灰蝶&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="s2">&#34;蓝灰蝶&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="s2">&#34;青海红珠灰蝶&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="s2">&#34;古北拟酒眼蝶&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="s2">&#34;阿芬眼蝶&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="s2">&#34;拟稻眉眼蝶&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="s2">&#34;牧女珍眼蝶&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="s2">&#34;白眼蝶&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="s2">&#34;菩萨酒眼蝶&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="s2">&#34;西门珍眼蝶&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="s2">&#34;边纹黛眼蝶&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="s2">&#34;云粉蝶&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="s2">&#34;侏粉蝶&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="s2">&#34;大卫粉蝶&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="s2">&#34;大翅绢粉蝶&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="s2">&#34;山豆粉蝶&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="s2">&#34;橙黄豆粉蝶&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="s2">&#34;突角小粉蝶&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="s2">&#34;箭纹云粉蝶&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="s2">&#34;箭纹绢粉蝶&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="s2">&#34;红襟粉蝶&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="s2">&#34;绢粉蝶&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="s2">&#34;菜粉蝶&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="s2">&#34;镉黄迁粉蝶&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="s2">&#34;黎明豆粉蝶&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="s2">&#34;依帕绢蝶&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="s2">&#34;四川绢蝶&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="s2">&#34;珍珠绢蝶&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="s2">&#34;中环蛱蝶&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="s2">&#34;云豹蛱蝶&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="s2">&#34;伊诺小豹蛱蝶&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="s2">&#34;小红蛱蝶&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="s2">&#34;扬眉线蛱蝶&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="s2">&#34;斐豹蛱蝶&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="s2">&#34;曲斑珠蛱蝶&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="s2">&#34;柱菲蛱蝶&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="s2">&#34;柳紫闪蛱蝶&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="s2">&#34;灿福蛱蝶&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="s2">&#34;玄珠带蛱蝶&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="s2">&#34;珍蛱蝶&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="s2">&#34;琉璃蛱蝶&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="s2">&#34;白钩蛱蝶&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="s2">&#34;秀蛱蝶&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="s2">&#34;绢蛱蝶&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="s2">&#34;绿豹蛱蝶&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="s2">&#34;网蛱蝶&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="s2">&#34;美眼蛱蝶&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="s2">&#34;翠蓝眼蛱蝶&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="s2">&#34;老豹蛱蝶&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="s2">&#34;荨麻蛱蝶&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="s2">&#34;虬眉带蛱蝶&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="s2">&#34;蟾福蛱蝶&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="s2">&#34;钩翅眼蛱蝶&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="s2">&#34;银斑豹蛱蝶&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="s2">&#34;银豹蛱蝶&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="s2">&#34;链环蛱蝶&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="s2">&#34;锦瑟蛱蝶&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="s2">&#34;黄环蛱蝶&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="s2">&#34;黄钩蛱蝶&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="s2">&#34;黑网蛱蝶&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="s2">&#34;宽边黄粉蝶&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="s2">&#34;尖翅翠蛱蝶&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="s2">&#34;素弄蝶&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="s2">&#34;翠袖锯眼蝶&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="s2">&#34;蓝点紫斑蝶&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="s2">&#34;蛇目褐蚬蝶&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="s2">&#34;雅弄蝶&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="p">]</span><span class="w">
</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><ul>
<li>删除<code>/content/yolov5/train.py</code>,上传更改过的<code>train.py</code></li>
<li>主要只更改了 <code>nc</code>的值</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c"># parameters</span><span class="w">
</span><span class="w"></span><span class="nt">nc</span><span class="p">:</span><span class="w"> </span><span class="m">94</span><span class="w">  </span><span class="c"># number of classes</span><span class="w">
</span><span class="w"></span><span class="nt">depth_multiple</span><span class="p">:</span><span class="w"> </span><span class="m">0.33</span><span class="w">  </span><span class="c"># model depth multiple</span><span class="w">
</span><span class="w"></span><span class="nt">width_multiple</span><span class="p">:</span><span class="w"> </span><span class="m">0.50</span><span class="w">  </span><span class="c"># layer channel multiple</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="c"># anchors</span><span class="w">
</span><span class="w"></span><span class="nt">anchors</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="p">[</span><span class="m">10</span><span class="p">,</span><span class="m">13</span><span class="p">,</span><span class="w"> </span><span class="m">16</span><span class="p">,</span><span class="m">30</span><span class="p">,</span><span class="w"> </span><span class="m">33</span><span class="p">,</span><span class="m">23</span><span class="p">]</span><span class="w">  </span><span class="c"># P3/8</span><span class="w">
</span><span class="w">  </span>- <span class="p">[</span><span class="m">30</span><span class="p">,</span><span class="m">61</span><span class="p">,</span><span class="w"> </span><span class="m">62</span><span class="p">,</span><span class="m">45</span><span class="p">,</span><span class="w"> </span><span class="m">59</span><span class="p">,</span><span class="m">119</span><span class="p">]</span><span class="w">  </span><span class="c"># P4/16</span><span class="w">
</span><span class="w">  </span>- <span class="p">[</span><span class="m">116</span><span class="p">,</span><span class="m">90</span><span class="p">,</span><span class="w"> </span><span class="m">156</span><span class="p">,</span><span class="m">198</span><span class="p">,</span><span class="w"> </span><span class="m">373</span><span class="p">,</span><span class="m">326</span><span class="p">]</span><span class="w">  </span><span class="c"># P5/32</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="c"># YOLOv5 backbone</span><span class="w">
</span><span class="w"></span><span class="nt">backbone</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="c"># [from, number, module, args]</span><span class="w">
</span><span class="w">  </span><span class="p">[[</span>-<span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="l">Focus, [64, 3]], </span><span class="w"> </span><span class="c"># 0-P1/2</span><span class="w">
</span><span class="w">   </span><span class="p">[</span>-<span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="l">Conv, [128, 3, 2]], </span><span class="w"> </span><span class="c"># 1-P2/4</span><span class="w">
</span><span class="w">   </span><span class="p">[</span>-<span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">3</span><span class="p">,</span><span class="w"> </span><span class="l">C3, [128]],</span><span class="w">
</span><span class="w">   </span><span class="p">[</span>-<span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="l">Conv, [256, 3, 2]], </span><span class="w"> </span><span class="c"># 3-P3/8</span><span class="w">
</span><span class="w">   </span><span class="p">[</span>-<span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">9</span><span class="p">,</span><span class="w"> </span><span class="l">C3, [256]],</span><span class="w">
</span><span class="w">   </span><span class="p">[</span>-<span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="l">Conv, [512, 3, 2]], </span><span class="w"> </span><span class="c"># 5-P4/16</span><span class="w">
</span><span class="w">   </span><span class="p">[</span>-<span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">9</span><span class="p">,</span><span class="w"> </span><span class="l">C3, [512]],</span><span class="w">
</span><span class="w">   </span><span class="p">[</span>-<span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="l">Conv, [1024, 3, 2]], </span><span class="w"> </span><span class="c"># 7-P5/32</span><span class="w">
</span><span class="w">   </span><span class="p">[</span>-<span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="l">SPP, [1024, [5, 9, 13]]],</span><span class="w">
</span><span class="w">   </span><span class="p">[</span>-<span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">3</span><span class="p">,</span><span class="w"> </span><span class="l">C3, [1024, False]], </span><span class="w"> </span><span class="c"># 9</span><span class="w">
</span><span class="w">  </span><span class="p">]</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="c"># YOLOv5 head</span><span class="w">
</span><span class="w"></span><span class="nt">head</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="p">[[</span>-<span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="l">Conv, [512, 1, 1]],</span><span class="w">
</span><span class="w">   </span><span class="p">[</span>-<span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="l">nn.Upsample, [None, 2, &#39;nearest&#39;]],</span><span class="w">
</span><span class="w">   </span><span class="p">[[</span>-<span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">6</span><span class="p">],</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="l">Concat, [1]], </span><span class="w"> </span><span class="c"># cat backbone P4</span><span class="w">
</span><span class="w">   </span><span class="p">[</span>-<span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">3</span><span class="p">,</span><span class="w"> </span><span class="l">C3, [512, False]], </span><span class="w"> </span><span class="c"># 13</span><span class="w">
</span><span class="w">
</span><span class="w">   </span><span class="p">[</span>-<span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="l">Conv, [256, 1, 1]],</span><span class="w">
</span><span class="w">   </span><span class="p">[</span>-<span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="l">nn.Upsample, [None, 2, &#39;nearest&#39;]],</span><span class="w">
</span><span class="w">   </span><span class="p">[[</span>-<span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">4</span><span class="p">],</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="l">Concat, [1]], </span><span class="w"> </span><span class="c"># cat backbone P3</span><span class="w">
</span><span class="w">   </span><span class="p">[</span>-<span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">3</span><span class="p">,</span><span class="w"> </span><span class="l">C3, [256, False]], </span><span class="w"> </span><span class="c"># 17 (P3/8-small)</span><span class="w">
</span><span class="w">
</span><span class="w">   </span><span class="p">[</span>-<span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="l">Conv, [256, 3, 2]],</span><span class="w">
</span><span class="w">   </span><span class="p">[[</span>-<span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">14</span><span class="p">],</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="l">Concat, [1]], </span><span class="w"> </span><span class="c"># cat head P4</span><span class="w">
</span><span class="w">   </span><span class="p">[</span>-<span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">3</span><span class="p">,</span><span class="w"> </span><span class="l">C3, [512, False]], </span><span class="w"> </span><span class="c"># 20 (P4/16-medium)</span><span class="w">
</span><span class="w">
</span><span class="w">   </span><span class="p">[</span>-<span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="l">Conv, [512, 3, 2]],</span><span class="w">
</span><span class="w">   </span><span class="p">[[</span>-<span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">10</span><span class="p">],</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="l">Concat, [1]], </span><span class="w"> </span><span class="c"># cat head P5</span><span class="w">
</span><span class="w">   </span><span class="p">[</span>-<span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">3</span><span class="p">,</span><span class="w"> </span><span class="l">C3, [1024, False]], </span><span class="w"> </span><span class="c"># 23 (P5/32-large)</span><span class="w">
</span><span class="w">
</span><span class="w">   </span><span class="p">[[</span><span class="m">17</span><span class="p">,</span><span class="w"> </span><span class="m">20</span><span class="p">,</span><span class="w"> </span><span class="m">23</span><span class="p">],</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="l">Detect, [nc, anchors]], </span><span class="w"> </span><span class="c"># Detect(P3, P4, P5)</span><span class="w">
</span><span class="w">  </span><span class="p">]</span><span class="w">
</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><ul>
<li>删除<code>/content/yolov5/train.py</code>, 上传你更改过的<code>train.py</code></li>
<li>主要更改了以下内容
<img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/clearyup/picgo/img/20210519212553.png"
        data-srcset="https://cdn.jsdelivr.net/gh/clearyup/picgo/img/20210519212553.png, https://cdn.jsdelivr.net/gh/clearyup/picgo/img/20210519212553.png 1.5x, https://cdn.jsdelivr.net/gh/clearyup/picgo/img/20210519212553.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/clearyup/picgo/img/20210519212553.png"
        title="https://cdn.jsdelivr.net/gh/clearyup/picgo/img/20210519212553.png" /></li>
<li>将生成的结果文件夹路径设置为<code>谷歌云盘的</code>, 避免断开连接拿不到训练结果
<img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/clearyup/picgo/img/20210520162946.png"
        data-srcset="https://cdn.jsdelivr.net/gh/clearyup/picgo/img/20210520162946.png, https://cdn.jsdelivr.net/gh/clearyup/picgo/img/20210520162946.png 1.5x, https://cdn.jsdelivr.net/gh/clearyup/picgo/img/20210520162946.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/clearyup/picgo/img/20210520162946.png"
        title="https://cdn.jsdelivr.net/gh/clearyup/picgo/img/20210520162946.png" /></li>
</ul>
<h3 id="开始训练">开始训练</h3>
<ul>
<li><code>batch-size</code>是批处理大小, 每批处理的数目, 比如有<code>3200</code>张图片, <code>batch-size</code>设置为<code>32</code>, 那数据会被分成<code>100</code>批, 每批 <code>32</code>张图片进行处理</li>
<li><code>epochs</code>是将所有的批次图片训练完就是<code>1</code>次<code>epochs</code>, 也叫<code>迭代次数</code></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">!python /content/yolov5/train.py --data mytrain.yaml --cfg yolov5s.yaml --weights weights/yolov5s.pt --epochs <span class="m">100</span> --batch-size <span class="m">16</span>

</code></pre></td></tr></table>
</div>
</div><h3 id="训练结果分析">训练结果分析</h3>
<ul>
<li>训练过程的参数如下</li>
<li><code>P</code>是查准率, <code>R</code>是查全率,  <code>mAp@.5</code>和<code>mAp@.5:.95</code>是用来评估模型的, 这些值越接近<code>1</code>越好, 类似<code>0.994</code>这种就比较好</li>
</ul>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/clearyup/picgo/img/20210519213749.png"
        data-srcset="https://cdn.jsdelivr.net/gh/clearyup/picgo/img/20210519213749.png, https://cdn.jsdelivr.net/gh/clearyup/picgo/img/20210519213749.png 1.5x, https://cdn.jsdelivr.net/gh/clearyup/picgo/img/20210519213749.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/clearyup/picgo/img/20210519213749.png"
        title="https://cdn.jsdelivr.net/gh/clearyup/picgo/img/20210519213749.png" /></p>
<ul>
<li>训练完成会生成一个<code>run</code>文件,里面的<code>weight</code>文件夹有生成的<code>权重文件</code></li>
</ul>
<h3 id="测试模型">测试模型</h3>
<ul>
<li>需要图片指定的是<code>yolov5/data/images</code>目录下, 不然检测不到</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">!python /content/yolov5/test.py   --augment --save-json

</code></pre></td></tr></table>
</div>
</div><h3 id="开始预测结果">开始预测结果</h3>
<ul>
<li>使用训练好的权重文件<code>best.pt</code>对数据进行预测</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">!python /content/yolov5/detect.py --save-json --save-txt --save-conf --nosave --augment
</code></pre></td></tr></table>
</div>
</div><ul>
<li>detect.py代码</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span><span class="lnt">264
</span><span class="lnt">265
</span><span class="lnt">266
</span><span class="lnt">267
</span><span class="lnt">268
</span><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span><span class="lnt">272
</span><span class="lnt">273
</span><span class="lnt">274
</span><span class="lnt">275
</span><span class="lnt">276
</span><span class="lnt">277
</span><span class="lnt">278
</span><span class="lnt">279
</span><span class="lnt">280
</span><span class="lnt">281
</span><span class="lnt">282
</span><span class="lnt">283
</span><span class="lnt">284
</span><span class="lnt">285
</span><span class="lnt">286
</span><span class="lnt">287
</span><span class="lnt">288
</span><span class="lnt">289
</span><span class="lnt">290
</span><span class="lnt">291
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python">
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">cv2</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torch.backends.cudnn</span> <span class="kn">as</span> <span class="nn">cudnn</span>

<span class="kn">from</span> <span class="nn">models.experimental</span> <span class="kn">import</span> <span class="n">attempt_load</span>
<span class="kn">from</span> <span class="nn">utils.datasets</span> <span class="kn">import</span> <span class="n">LoadStreams</span><span class="p">,</span> <span class="n">LoadImages</span>
<span class="kn">from</span> <span class="nn">utils.general</span> <span class="kn">import</span> <span class="n">check_img_size</span><span class="p">,</span> <span class="n">check_requirements</span><span class="p">,</span> <span class="n">check_imshow</span><span class="p">,</span> <span class="n">non_max_suppression</span><span class="p">,</span> <span class="n">apply_classifier</span><span class="p">,</span> \
    <span class="n">scale_coords</span><span class="p">,</span> <span class="n">xyxy2xywh</span><span class="p">,</span> <span class="n">strip_optimizer</span><span class="p">,</span> <span class="n">set_logging</span><span class="p">,</span> <span class="n">increment_path</span><span class="p">,</span> <span class="n">save_one_box</span>
<span class="kn">from</span> <span class="nn">utils.plots</span> <span class="kn">import</span> <span class="n">colors</span><span class="p">,</span> <span class="n">plot_one_box</span>
<span class="kn">from</span> <span class="nn">utils.torch_utils</span> <span class="kn">import</span> <span class="n">select_device</span><span class="p">,</span> <span class="n">load_classifier</span><span class="p">,</span> <span class="n">time_synchronized</span>


<span class="k">def</span> <span class="nf">detect</span><span class="p">(</span><span class="n">opt</span><span class="p">):</span>
    <span class="n">source</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">view_img</span><span class="p">,</span> <span class="n">save_txt</span><span class="p">,</span> <span class="n">imgsz</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">opt</span><span class="o">.</span><span class="n">weights</span><span class="p">,</span> <span class="n">opt</span><span class="o">.</span><span class="n">view_img</span><span class="p">,</span> <span class="n">opt</span><span class="o">.</span><span class="n">save_txt</span><span class="p">,</span> <span class="n">opt</span><span class="o">.</span><span class="n">img_size</span>
    <span class="n">save_img</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">opt</span><span class="o">.</span><span class="n">nosave</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">source</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.txt&#39;</span><span class="p">)</span>  <span class="c1"># save inference images</span>
    <span class="n">webcam</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">isnumeric</span><span class="p">()</span> <span class="ow">or</span> <span class="n">source</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.txt&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">source</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span>
        <span class="p">(</span><span class="s1">&#39;rtsp://&#39;</span><span class="p">,</span> <span class="s1">&#39;rtmp://&#39;</span><span class="p">,</span> <span class="s1">&#39;http://&#39;</span><span class="p">,</span> <span class="s1">&#39;https://&#39;</span><span class="p">))</span>

    <span class="n">save_json</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">save_json</span>
    <span class="n">mdict</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># Directories</span>
    <span class="n">save_dir</span> <span class="o">=</span> <span class="n">increment_path</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">opt</span><span class="o">.</span><span class="n">project</span><span class="p">)</span> <span class="o">/</span> <span class="n">opt</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="n">opt</span><span class="o">.</span><span class="n">exist_ok</span><span class="p">)</span>  <span class="c1"># increment run</span>
    <span class="p">(</span><span class="n">save_dir</span> <span class="o">/</span> <span class="s1">&#39;labels&#39;</span> <span class="k">if</span> <span class="n">save_txt</span> <span class="k">else</span> <span class="n">save_dir</span><span class="p">)</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>  <span class="c1"># make dir</span>

    <span class="c1"># Initialize</span>
    <span class="n">set_logging</span><span class="p">()</span>
    <span class="n">device</span> <span class="o">=</span> <span class="n">select_device</span><span class="p">(</span><span class="n">opt</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
    <span class="n">half</span> <span class="o">=</span> <span class="n">device</span><span class="o">.</span><span class="n">type</span> <span class="o">!=</span> <span class="s1">&#39;cpu&#39;</span>  <span class="c1"># half precision only supported on CUDA</span>

    <span class="c1"># Load model</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">attempt_load</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">map_location</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>  <span class="c1"># load FP32 model</span>
    <span class="n">stride</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">stride</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>  <span class="c1"># model stride</span>
    <span class="n">imgsz</span> <span class="o">=</span> <span class="n">check_img_size</span><span class="p">(</span><span class="n">imgsz</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">stride</span><span class="p">)</span>  <span class="c1"># check img_size</span>
    <span class="n">names</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">names</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;module&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="n">model</span><span class="o">.</span><span class="n">names</span>  <span class="c1"># get class names</span>
    <span class="k">if</span> <span class="n">half</span><span class="p">:</span>
        <span class="n">model</span><span class="o">.</span><span class="n">half</span><span class="p">()</span>  <span class="c1"># to FP16</span>

    <span class="c1"># Second-stage classifier</span>
    <span class="n">classify</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">if</span> <span class="n">classify</span><span class="p">:</span>
        <span class="n">modelc</span> <span class="o">=</span> <span class="n">load_classifier</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;resnet101&#39;</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># initialize</span>
        <span class="n">modelc</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;weights/resnet101.pt&#39;</span><span class="p">,</span> <span class="n">map_location</span><span class="o">=</span><span class="n">device</span><span class="p">)[</span><span class="s1">&#39;model&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>

    <span class="c1"># Set Dataloader</span>
    <span class="n">vid_path</span><span class="p">,</span> <span class="n">vid_writer</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="n">webcam</span><span class="p">:</span>
        <span class="n">view_img</span> <span class="o">=</span> <span class="n">check_imshow</span><span class="p">()</span>
        <span class="n">cudnn</span><span class="o">.</span><span class="n">benchmark</span> <span class="o">=</span> <span class="bp">True</span>  <span class="c1"># set True to speed up constant image size inference</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">LoadStreams</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">img_size</span><span class="o">=</span><span class="n">imgsz</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="n">stride</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">LoadImages</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">img_size</span><span class="o">=</span><span class="n">imgsz</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="n">stride</span><span class="p">)</span>

    <span class="c1"># Run inference</span>
    <span class="k">if</span> <span class="n">device</span><span class="o">.</span><span class="n">type</span> <span class="o">!=</span> <span class="s1">&#39;cpu&#39;</span><span class="p">:</span>
        <span class="n">model</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">imgsz</span><span class="p">,</span> <span class="n">imgsz</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">())))</span>  <span class="c1"># run once</span>
    <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">path</span><span class="p">,</span> <span class="n">img</span><span class="p">,</span> <span class="n">im0s</span><span class="p">,</span> <span class="n">vid_cap</span> <span class="ow">in</span> <span class="n">dataset</span><span class="p">:</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">img</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">half</span><span class="p">()</span> <span class="k">if</span> <span class="n">half</span> <span class="k">else</span> <span class="n">img</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>  <span class="c1"># uint8 to fp16/32</span>
        <span class="n">img</span> <span class="o">/=</span> <span class="mf">255.0</span>  <span class="c1"># 0 - 255 to 0.0 - 1.0</span>
        <span class="k">if</span> <span class="n">img</span><span class="o">.</span><span class="n">ndimension</span><span class="p">()</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Inference</span>
        <span class="n">t1</span> <span class="o">=</span> <span class="n">time_synchronized</span><span class="p">()</span>
        <span class="n">pred</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">augment</span><span class="o">=</span><span class="n">opt</span><span class="o">.</span><span class="n">augment</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Apply NMS</span>
        <span class="n">pred</span> <span class="o">=</span> <span class="n">non_max_suppression</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="n">opt</span><span class="o">.</span><span class="n">conf_thres</span><span class="p">,</span> <span class="n">opt</span><span class="o">.</span><span class="n">iou_thres</span><span class="p">,</span> <span class="n">opt</span><span class="o">.</span><span class="n">classes</span><span class="p">,</span> <span class="n">opt</span><span class="o">.</span><span class="n">agnostic_nms</span><span class="p">,</span>
                                   <span class="n">max_det</span><span class="o">=</span><span class="n">opt</span><span class="o">.</span><span class="n">max_det</span><span class="p">)</span>
        <span class="n">t2</span> <span class="o">=</span> <span class="n">time_synchronized</span><span class="p">()</span>

        <span class="c1"># Apply Classifier</span>
        <span class="k">if</span> <span class="n">classify</span><span class="p">:</span>
            <span class="n">pred</span> <span class="o">=</span> <span class="n">apply_classifier</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="n">modelc</span><span class="p">,</span> <span class="n">img</span><span class="p">,</span> <span class="n">im0s</span><span class="p">)</span>

        <span class="c1"># Process detections</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">det</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pred</span><span class="p">):</span>  <span class="c1"># detections per image</span>
            <span class="k">if</span> <span class="n">webcam</span><span class="p">:</span>  <span class="c1"># batch_size &gt;= 1</span>
                <span class="n">p</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">im0</span><span class="p">,</span> <span class="n">frame</span> <span class="o">=</span> <span class="n">path</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">f</span><span class="s1">&#39;{i}: &#39;</span><span class="p">,</span> <span class="n">im0s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">dataset</span><span class="o">.</span><span class="n">count</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">p</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">im0</span><span class="p">,</span> <span class="n">frame</span> <span class="o">=</span> <span class="n">path</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">im0s</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="s1">&#39;frame&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

            <span class="n">p</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>  <span class="c1"># to Path</span>
            <span class="n">save_path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">save_dir</span> <span class="o">/</span> <span class="n">p</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>  <span class="c1"># img.jpg</span>
            <span class="n">txt_path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">save_dir</span> <span class="o">/</span> <span class="s1">&#39;labels&#39;</span> <span class="o">/</span> <span class="n">p</span><span class="o">.</span><span class="n">stem</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="n">dataset</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;image&#39;</span> <span class="k">else</span> <span class="n">f</span><span class="s1">&#39;_{frame}&#39;</span><span class="p">)</span>  <span class="c1"># img.txt</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="si">%g</span><span class="s1">x</span><span class="si">%g</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>  <span class="c1"># print string</span>
            <span class="n">gn</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">im0</span><span class="o">.</span><span class="n">shape</span><span class="p">)[[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]</span>  <span class="c1"># normalization gain whwh</span>
            <span class="n">imc</span> <span class="o">=</span> <span class="n">im0</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="k">if</span> <span class="n">opt</span><span class="o">.</span><span class="n">save_crop</span> <span class="k">else</span> <span class="n">im0</span>  <span class="c1"># for opt.save_crop</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">det</span><span class="p">):</span>
                <span class="c1"># Rescale boxes from img_size to im0 size</span>
                <span class="n">det</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">scale_coords</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">:],</span> <span class="n">det</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">4</span><span class="p">],</span> <span class="n">im0</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">()</span>

                <span class="c1"># Print results</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">det</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
                    <span class="n">n</span> <span class="o">=</span> <span class="p">(</span><span class="n">det</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">c</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>  <span class="c1"># detections per class</span>
                    <span class="n">s</span> <span class="o">+=</span> <span class="n">f</span><span class="s2">&#34;{n} {names[int(c)]}{&#39;s&#39; * (n &gt; 1)}, &#34;</span>  <span class="c1"># add to string</span>

                <span class="c1"># Write results</span>
                <span class="k">for</span> <span class="o">*</span><span class="n">xyxy</span><span class="p">,</span> <span class="n">conf</span><span class="p">,</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">det</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">save_txt</span><span class="p">:</span>  <span class="c1"># Write to file</span>
                        <span class="n">xywh</span> <span class="o">=</span> <span class="p">(</span><span class="n">xyxy2xywh</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">xyxy</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span> <span class="o">/</span> <span class="n">gn</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>  <span class="c1"># normalized xywh</span>
                        <span class="n">line</span> <span class="o">=</span> <span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">xyxy</span><span class="p">,</span> <span class="n">conf</span><span class="p">)</span> <span class="k">if</span> <span class="n">opt</span><span class="o">.</span><span class="n">save_conf</span> <span class="k">else</span> <span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">xywh</span><span class="p">)</span>  <span class="c1"># label format</span>
                        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">txt_path</span> <span class="o">+</span> <span class="s1">&#39;.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">((</span><span class="s1">&#39;</span><span class="si">%g</span><span class="s1"> &#39;</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">))</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span> <span class="o">%</span> <span class="n">line</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
 
                    
                    <span class="k">if</span> <span class="n">save_json</span><span class="p">:</span>
                        <span class="n">myxyxy</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">xyxy</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                        <span class="n">img_id</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">stem</span>
                        <span class="n">result_class</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">cls</span><span class="p">))</span>
                        <span class="n">result_conf</span>  <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">conf</span><span class="p">))</span>
                        <span class="n">content_json</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="n">result_class</span><span class="p">:[[</span>
                                 <span class="n">img_id</span><span class="p">,</span>
                                 <span class="n">result_conf</span><span class="p">,</span>
                                 <span class="n">myxyxy</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                 <span class="n">myxyxy</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                 <span class="n">myxyxy</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                                 <span class="n">myxyxy</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
                                
                                 <span class="p">]]</span>
                            <span class="p">}</span>
                        <span class="n">mdict</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">content_json</span><span class="p">)</span>
                        

                    <span class="k">if</span> <span class="n">save_img</span> <span class="ow">or</span> <span class="n">opt</span><span class="o">.</span><span class="n">save_crop</span> <span class="ow">or</span> <span class="n">view_img</span><span class="p">:</span>  <span class="c1"># Add bbox to image</span>
                        <span class="n">c</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>  <span class="c1"># integer class</span>
                        <span class="n">label</span> <span class="o">=</span> <span class="bp">None</span> <span class="k">if</span> <span class="n">opt</span><span class="o">.</span><span class="n">hide_labels</span> <span class="k">else</span> <span class="p">(</span><span class="n">names</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="k">if</span> <span class="n">opt</span><span class="o">.</span><span class="n">hide_conf</span> <span class="k">else</span> <span class="n">f</span><span class="s1">&#39;{names[c]} {conf:.2f}&#39;</span><span class="p">)</span>
                        <span class="n">plot_one_box</span><span class="p">(</span><span class="n">xyxy</span><span class="p">,</span> <span class="n">im0</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="bp">True</span><span class="p">),</span> <span class="n">line_thickness</span><span class="o">=</span><span class="n">opt</span><span class="o">.</span><span class="n">line_thickness</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">opt</span><span class="o">.</span><span class="n">save_crop</span><span class="p">:</span>
                            <span class="n">save_one_box</span><span class="p">(</span><span class="n">xyxy</span><span class="p">,</span> <span class="n">imc</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">save_dir</span> <span class="o">/</span> <span class="s1">&#39;crops&#39;</span> <span class="o">/</span> <span class="n">names</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">/</span> <span class="n">f</span><span class="s1">&#39;{p.stem}.jpg&#39;</span><span class="p">,</span> <span class="n">BGR</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

            <span class="c1"># Print time (inference + NMS)</span>
            <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;{s}Done. ({t2 - t1:.3f}s)&#39;</span><span class="p">)</span>

            <span class="c1"># Stream results</span>
            <span class="k">if</span> <span class="n">view_img</span><span class="p">:</span>
                <span class="n">cv2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="n">im0</span><span class="p">)</span>
                <span class="n">cv2</span><span class="o">.</span><span class="n">waitKey</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># 1 millisecond</span>

            <span class="c1"># Save results (image with detections)</span>
            <span class="k">if</span> <span class="n">save_img</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">dataset</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;image&#39;</span><span class="p">:</span>
                    <span class="n">cv2</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="n">im0</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>  <span class="c1"># &#39;video&#39; or &#39;stream&#39;</span>
                    <span class="k">if</span> <span class="n">vid_path</span> <span class="o">!=</span> <span class="n">save_path</span><span class="p">:</span>  <span class="c1"># new video</span>
                        <span class="n">vid_path</span> <span class="o">=</span> <span class="n">save_path</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vid_writer</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">VideoWriter</span><span class="p">):</span>
                            <span class="n">vid_writer</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>  <span class="c1"># release previous video writer</span>
                        <span class="k">if</span> <span class="n">vid_cap</span><span class="p">:</span>  <span class="c1"># video</span>
                            <span class="n">fps</span> <span class="o">=</span> <span class="n">vid_cap</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">CAP_PROP_FPS</span><span class="p">)</span>
                            <span class="n">w</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">vid_cap</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">CAP_PROP_FRAME_WIDTH</span><span class="p">))</span>
                            <span class="n">h</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">vid_cap</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">CAP_PROP_FRAME_HEIGHT</span><span class="p">))</span>
                        <span class="k">else</span><span class="p">:</span>  <span class="c1"># stream</span>
                            <span class="n">fps</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="mi">30</span><span class="p">,</span> <span class="n">im0</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">im0</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="n">save_path</span> <span class="o">+=</span> <span class="s1">&#39;.mp4&#39;</span>
                        <span class="n">vid_writer</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">VideoWriter</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">VideoWriter_fourcc</span><span class="p">(</span><span class="o">*</span><span class="s1">&#39;mp4v&#39;</span><span class="p">),</span> <span class="n">fps</span><span class="p">,</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">))</span>
                    <span class="n">vid_writer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">im0</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">save_txt</span> <span class="ow">or</span> <span class="n">save_img</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">f</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">{len(list(save_dir.glob(&#39;labels/*.txt&#39;)))} labels saved to {save_dir / &#39;labels&#39;}&#34;</span> <span class="k">if</span> <span class="n">save_txt</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&#34;Results saved to {save_dir}{s}&#34;</span><span class="p">)</span>

    <span class="c1">#找到属性名</span>
    <span class="k">def</span> <span class="nf">findname</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">arr</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
            <span class="k">return</span> <span class="n">n</span>

    <span class="c1">#合并</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">mdict</span><span class="p">):</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">findname</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">mdict</span><span class="p">)</span>
        <span class="n">j</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">while</span><span class="p">(</span><span class="n">j</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">mdict</span><span class="p">)):</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">findname</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">mdict</span><span class="p">)</span>
            <span class="k">if</span><span class="p">(</span><span class="n">p</span> <span class="o">==</span> <span class="n">n</span><span class="p">):</span>
                <span class="n">mdict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">mdict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">+</span> <span class="n">mdict</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">p</span><span class="p">]</span>
            <span class="n">j</span><span class="o">+=</span><span class="mi">1</span>
        <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>

    <span class="c1">#去重</span>
    <span class="k">def</span> <span class="nf">noRepeat</span><span class="p">(</span><span class="n">mjson</span><span class="p">):</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span><span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">mjson</span><span class="p">)):</span>
            <span class="n">j</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">while</span><span class="p">(</span><span class="n">j</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">mjson</span><span class="p">)):</span>
                <span class="k">if</span><span class="p">(</span><span class="n">findname</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">mjson</span><span class="p">)</span> <span class="o">==</span> <span class="n">findname</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">mjson</span><span class="p">)):</span>
                    <span class="k">del</span><span class="p">(</span><span class="n">mjson</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
                <span class="n">j</span><span class="o">+=</span><span class="mi">1</span>
            <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>

    <span class="n">noRepeat</span><span class="p">(</span><span class="n">mdict</span><span class="p">)</span>

    <span class="c1">#归并排序</span>
    <span class="k">def</span> <span class="nf">merge</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">while</span> <span class="n">left</span> <span class="ow">and</span> <span class="n">right</span><span class="p">:</span>
            <span class="c1">#if left[0] &lt;= right[0]:</span>
            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">findname</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">left</span><span class="p">))</span> <span class="o">&lt;=</span> <span class="nb">int</span><span class="p">(</span><span class="n">findname</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">right</span><span class="p">)):</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">left</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">right</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">left</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">+=</span> <span class="n">left</span>
        <span class="k">if</span> <span class="n">right</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">+=</span> <span class="n">right</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">merge_sort</span><span class="p">(</span><span class="n">L</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">L</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># When D&amp;C to 1 element, just return it</span>
            <span class="k">return</span> <span class="n">L</span>
        <span class="n">mid</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">L</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="n">left</span> <span class="o">=</span> <span class="n">L</span><span class="p">[:</span><span class="n">mid</span><span class="p">]</span>
        <span class="n">right</span> <span class="o">=</span> <span class="n">L</span><span class="p">[</span><span class="n">mid</span><span class="p">:]</span>

        <span class="n">left</span> <span class="o">=</span> <span class="n">merge_sort</span><span class="p">(</span><span class="n">left</span><span class="p">)</span>
        <span class="n">right</span> <span class="o">=</span> <span class="n">merge_sort</span><span class="p">(</span><span class="n">right</span><span class="p">)</span>
        <span class="c1"># conquer sub-problem recursively</span>
        <span class="k">return</span> <span class="n">merge</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">)</span>
        <span class="c1"># return the answer of sub-problem</span>

    <span class="n">mjson</span> <span class="o">=</span> <span class="n">merge_sort</span><span class="p">(</span><span class="n">mdict</span><span class="p">)</span>

    <span class="c1">#消除大括号(一)</span>
    <span class="k">def</span> <span class="nf">extend</span><span class="p">(</span><span class="n">target</span><span class="p">,</span><span class="n">source</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">source</span><span class="p">:</span>
            <span class="n">target</span><span class="p">[</span><span class="n">obj</span><span class="p">]</span> <span class="o">=</span> <span class="n">source</span><span class="p">[</span><span class="n">obj</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">target</span>

    <span class="n">newjson</span> <span class="o">=</span> <span class="n">extend</span><span class="p">(</span><span class="n">mjson</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">mjson</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">i</span><span class="o">=</span><span class="mi">2</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">mjson</span><span class="p">):</span>
        <span class="n">newjson</span> <span class="o">=</span> <span class="n">extend</span><span class="p">(</span><span class="n">newjson</span><span class="p">,</span><span class="n">mjson</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>
    <span class="n">mdict</span><span class="o">=</span><span class="n">newjson</span>
    <span class="c1">#单引号改双引号</span>
    <span class="c1">#mdict = str(newjson).replace(&#34;&#39;&#34;,&#34;\&#34;&#34;).replace(r&#34;\n&#34;,&#34;&#34;)</span>
    
    <span class="k">if</span> <span class="n">save_json</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">mdict</span><span class="p">):</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">weights</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="n">weights</span><span class="p">)</span><span class="o">.</span><span class="n">stem</span> <span class="k">if</span> <span class="n">weights</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>  <span class="c1"># weights</span>
        
        <span class="n">pred_json</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">save_dir</span> <span class="o">/</span> <span class="n">f</span><span class="s2">&#34;{w}_predictions.json&#34;</span><span class="p">)</span>  <span class="c1"># predictions json</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Evaluating pycocotools mAP... saving </span><span class="si">%s</span><span class="s1">...&#39;</span> <span class="o">%</span> <span class="n">pred_json</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">pred_json</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">mdict</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>

    <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Done. ({time.time() - t0:.3f}s)&#39;</span><span class="p">)</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--weights&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;/content/drive/MyDrive/run/train/exp2/weights/best098.pt&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;model.pt path(s)&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--source&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;/content/yolov5/data/images&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;source&#39;</span><span class="p">)</span>  <span class="c1"># file/folder, 0 for webcam</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--img-size&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">640</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;inference size (pixels)&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--conf-thres&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;object confidence threshold&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--iou-thres&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;IOU threshold for NMS&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--max-det&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;maximum number of detections per image&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--device&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;cuda device, i.e. 0 or 0,1,2,3 or cpu&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--view-img&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;display results&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--save-txt&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;save results to *.txt&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--save-json&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;save results to json&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--save-conf&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;save confidences in --save-txt labels&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--save-crop&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;save cropped prediction boxes&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--nosave&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;do not save images/videos&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--classes&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;filter by class: --class 0, or --class 0 2 3&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--agnostic-nms&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;class-agnostic NMS&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--augment&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;augmented inference&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--update&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;update all models&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--project&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;runs/detect&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;save results to project/name&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--name&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;exp&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;save results to project/name&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--exist-ok&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;existing project/name ok, do not increment&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--line-thickness&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;bounding box thickness (pixels)&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--hide-labels&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;hide labels&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--hide-conf&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;hide confidences&#39;</span><span class="p">)</span>
    <span class="n">opt</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span><span class="n">opt</span><span class="p">)</span>
    <span class="n">check_requirements</span><span class="p">(</span><span class="n">exclude</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;tensorboard&#39;</span><span class="p">,</span> <span class="s1">&#39;pycocotools&#39;</span><span class="p">,</span> <span class="s1">&#39;thop&#39;</span><span class="p">))</span>

    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">opt</span><span class="o">.</span><span class="n">update</span><span class="p">:</span>  <span class="c1"># update all models (to fix SourceChangeWarning)</span>
            <span class="k">for</span> <span class="n">opt</span><span class="o">.</span><span class="n">weights</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;yolov5s.pt&#39;</span><span class="p">,</span> <span class="s1">&#39;yolov5m.pt&#39;</span><span class="p">,</span> <span class="s1">&#39;yolov5l.pt&#39;</span><span class="p">,</span> <span class="s1">&#39;yolov5x.pt&#39;</span><span class="p">]:</span>
                <span class="n">detect</span><span class="p">(</span><span class="n">opt</span><span class="o">=</span><span class="n">opt</span><span class="p">)</span>
                <span class="n">strip_optimizer</span><span class="p">(</span><span class="n">opt</span><span class="o">.</span><span class="n">weights</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">detect</span><span class="p">(</span><span class="n">opt</span><span class="o">=</span><span class="n">opt</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div></div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>更新于 2021-05-16</span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw"></i>&nbsp;<a href="/tags/yolov5/">yolov5</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/posts/vim/" class="prev" rel="prev" title="Vim宏的使用"><i class="fas fa-angle-left fa-fw"></i>Vim宏的使用</a></div>
</div>
<div id="comments"><div id="utterances"></div><noscript>
                Please enable JavaScript to view the comments powered by <a href="https://utteranc.es/">Utterances</a>.
            </noscript></div></article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line"><span class="author" itemprop="copyrightHolder">&nbsp;<a href="clearyup.github.io" target="_blank">@clear</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="回到顶部">
                <i class="fas fa-arrow-up fa-fw"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="查看评论">
                <i class="fas fa-comment fa-fw"></i>
            </a>
        </div><link rel="stylesheet" href="/lib/lightgallery/lightgallery.min.css"><link rel="stylesheet" href="/lib/katex/katex.min.css"><link rel="stylesheet" href="/lib/katex/copy-tex.min.css"><script type="text/javascript" src="/lib/smooth-scroll/smooth-scroll.min.js"></script><script type="text/javascript" src="/lib/autocomplete/autocomplete.min.js"></script><script type="text/javascript" src="/lib/algoliasearch/algoliasearch-lite.umd.min.js"></script><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/lightgallery/lightgallery.min.js"></script><script type="text/javascript" src="/lib/lightgallery/lg-thumbnail.min.js"></script><script type="text/javascript" src="/lib/lightgallery/lg-zoom.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="/lib/sharer/sharer.min.js"></script><script type="text/javascript" src="/lib/katex/katex.min.js"></script><script type="text/javascript" src="/lib/katex/auto-render.min.js"></script><script type="text/javascript" src="/lib/katex/copy-tex.min.js"></script><script type="text/javascript" src="/lib/katex/mhchem.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"复制到剪贴板","maxShownLines":10},"comment":{"utterances":{"darkTheme":"github-dark","issueTerm":"pathname","label":"","lightTheme":"github-light","repo":"clearyup/clearyup.github.io"}},"lightGallery":{"actualSize":false,"exThumbImage":"data-thumbnail","hideBarsDelay":2000,"selector":".lightgallery","speed":400,"thumbContHeight":80,"thumbWidth":80,"thumbnail":true},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"search":{"algoliaAppID":"RF9CYMTLK8","algoliaIndex":"clearblog","algoliaSearchKey":"135b22fbb7d42fd1262661d2af871d9a","highlightTag":"em","maxResultLength":10,"noResultsFound":"没有找到结果","snippetLength":50,"type":"algolia"}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
